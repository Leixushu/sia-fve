\NeedsTeXFormat{LaTeX2e}
\documentclass[twocolumn]{igs}
%\documentclass[review,letterpaper]{igs}

\usepackage{verbatim,xspace,amsmath,amssymb,bm}

\usepackage{tikz}
\usetikzlibrary{arrows}

\usepackage{igsnatbib}  % see igs2eguide.tex for example citation styles

\newcommand{\onecol}[1]{\includegraphics[width=86mm]{#1}}
\newcommand{\twocol}[1]{\includegraphics[width=178mm]{#1}}

% math macros
\newcommand\bb{\mathbf{b}}
\newcommand\bbf{\mathbf{f}}
\newcommand\bn{\mathbf{n}}
\newcommand\bq{\mathbf{q}}
\newcommand\bu{\mathbf{u}}
\newcommand\bv{\mathbf{v}}
\newcommand\by{\mathbf{y}}

\newcommand\bQ{\mathbf{Q}}
\newcommand\bV{\mathbf{V}}
\newcommand\bW{\mathbf{W}}
\newcommand\bX{\mathbf{X}}

\newcommand\CC{\mathbb{C}}
\newcommand{\DDt}[1]{\ensuremath{\frac{d #1}{d t}}}
\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\newcommand{\ddxp}[1]{\ensuremath{\frac{\partial #1}{\partial x'}}}
\newcommand{\ddz}[1]{\ensuremath{\frac{\partial #1}{\partial z}}}
\newcommand{\ddxx}[1]{\ensuremath{\frac{\partial^2 #1}{\partial x^2}}}
\newcommand{\ddyy}[1]{\ensuremath{\frac{\partial^2 #1}{\partial y^2}}}
\newcommand{\ddxy}[1]{\ensuremath{\frac{\partial^2 #1}{\partial x \partial y}}}
\newcommand{\ddzz}[1]{\ensuremath{\frac{\partial^2 #1}{\partial z^2}}}
\newcommand{\Div}{\nabla\cdot}
\newcommand\eps{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\ihat}{\mathbf{i}}
\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}
\newcommand{\jhat}{\mathbf{j}}
\newcommand{\khat}{\mathbf{k}}
\newcommand{\nhat}{\mathbf{n}}
\newcommand\lam{\lambda}
\newcommand\lap{\triangle}
\newcommand\RR{\mathbb{R}}
\newcommand\vf{\varphi}

\newcommand{\Mstar}{$\text{Mahaffy}^{\bigstar}$\xspace}

\newcommand\alpharight{\alpha_{{}_{\blacktriangleright}}}
\newcommand\alphaup{\alpha_{{\!}_{\blacktriangle}}}

\newcommand{\dxtwo}{\tfrac{\Delta x}{2}}
\newcommand{\dytwo}{\tfrac{\Delta y}{2}}

\newcommand{\half}{\tfrac{1}{2}}


\begin{document}

\title[Stable FVE schemes for the shallow ice approximation]{Stable finite volume element schemes \\ for the shallow ice approximation}

\abstract{The isothermal, non-sliding shallow ice approximation is a model for ice sheet and glacier flow which determines the ice geometry as the solution of a free-boundary problem.  By solving the steady-state version of the problem, we demonstrate a fully-implicit scheme with no stability restrictions.  We first consider the \cite{Mahaffy1976} finite difference calculation of discrete flux, but re-interpreted as a ``finite volume element'' (FVE) scheme.  In this FVE context, both everywhere-defined approximations and a finite volume integral form of the conservation statement are available.  Thereby we build an improved scheme which has both a better quadrature in the integral and upwinding on the part of the flux coming from the bed gradient.  By solving both the original and improved schemes in steady state by a parallel Newton scheme, respecting the constraint that thicknesses are nonnegative, we show that the improved scheme has superior accuracy to any published results both for flat bed \citep{Bueler2003} and bedrock-step \citep{JaroschSchoofAnslow2013} exact solutions.  We then apply the improved scheme at 1km resolution to the compute the steady-state geometry of the Greenland ice sheet, using only bedrock elevation and present-day surface mass balance data, in a laptop-scale computation.}

\author{Ed Bueler}

\affiliation{Department of Mathematics and Statistics, and Geophysical Institute, University of Alaska Fairbanks, USA \\
E-mail: \emph{\texttt{elbueler\@@alaska.edu}}}

\maketitle

\sectionsize


\section*{Introduction}

The finite difference (FD) scheme introduced by \cite{Mahaffy1976} for modeling the Barnes Ice Cap was a first success in modeling ice sheet flow and geometry evolution in two horizontal dimensions.  The scheme solves the shallow ice approximation (SIA; Hutter, 1983)\nocite{Hutter1983} by computing the ice flux at staggered-grid points by particular choices for evaluating the ice surface slope and thickness.  An advantage of the scheme is its relatively-small stencil, which reduces memory usage in implicit implementations \citep{HindmarshPayne1996,Mahaffy1976} and interprocess communication in parallel implementations \citep{Bueleretal2007}.  Its stability and accuracy properties as an explicit scheme are relatively-well understood in flat-bed cases \citep{Bueleretal2005,HindmarshPayne1996}.  It can also be used as the deformational part of a membrane-stress-resolving hybrid stress balance solution method \citep{BuelerBrown2009}.

Existing numerical schemes for the SIA solve the time-dependent SIA with explicit, semi-implicit, or fully-implicit schemes with known or apparent stability restrictions \citep[among others]{Bueleretal2005,EgholmNielsen2010,HindmarshPayne1996,Huybrechtsetal1996,
JaroschSchoofAnslow2013}.  In these applications the SIA is solved with essentially \emph{ad hoc} treatment of the free margin of the ice sheet, for example using projection in explicit schemes to reset computed negative thicknesses back to zero \citep{Bueleretal2005,JaroschSchoofAnslow2013}.

\cite{JouvetBueler2012} construct the one exception to the above usage pattern.  They pose and numerically-solve the steady state SIA free-boundary problem as a variational inequality \citep{KinderlehrerStampacchia} which includes the nonnegative-ice-thickness constraint.  Here we follow \cite{JouvetBueler2012} in solving the steady state free-boundary problem, but we do it by re-interpreting the well-known Mahaffy method so that it becomes a highly-accurate and scalable scheme.  The new schemes are non-the-less easy to implement because Newton solvers modified to including the nonnegative-thickness constraint \citep{BensonMunson2006} are available within the open-source PETSc library \citep{Balayetal2014}.

In fact we show that the classical \cite{Mahaffy1976} FD scheme is simply a non-standard quadrature choice in a conforming finite element (FE) method.  The trial functions are piecewise-bilinear on a structured grid of rectangles---i.e.~$Q^1$ finite elements \citep{Elmanetal2005}.  The test functions are piecewise-constant with support on dual rectangular control volumes, so the scheme can be regarded as either a Petrov-Galerkin method \citep{Elmanetal2005} or as a ``finite volume element'' (FVE) method \citep{Cai1990,EwingLinLin2002}.  We adopt the latter terminology because of the enhanced clarity which comes from regarding the mass conservation equation in classical flux-integral, i.e.~finite volume, form.

Based on this re-interpretation of the Mahaffy scheme we propose and test a ``\Mstar'' scheme which uses an obvious, and more accurate, quadrature choice when evaluating the finite volume flux integral.  The new scheme also uses first-order upwinding on the part of the flux that comes from the bedrock slope, but we see that the results are actually better than those from higher-resolution schemes when applied to a bedrock-step exact solution \citep{JaroschSchoofAnslow2013}.  Nonetheless the scheme is based on the same stencil, i.e.~uses only the same gridded values, as the classical Mahaffy scheme.  We also describe how to construct the improved scheme on unstructured finite element triangulations with dual control volumes, i.e.~Delaunay/Voronoi dual meshes \citep{EgholmNielsen2010,Ringleretal2013}.

\section*{Continuum model}

The time-dependent evolution equation for the ice thickness $H$ is a mass conservation equation,
\begin{equation}
\frac{\partial H}{\partial t} + \Div \bq = m,  \label{eq:siaevolution}
\end{equation}
where $\bq$ denotes the vertically-integrated flux (units $\text{m}^2/\text{s}$) and $m$ ($\text{m}/\text{s}$) is the surface mass balance, also called the accumulation/ablation function.  The divergence ``$\Div$'' is computed in horizontal $x,y$ directions only.

The SIA continuum model is the lubrication approximation \citep{Fowler1997} of the Stokes equations for slow-flowing ice, in non-sliding contact with the bed and with a freely-evolving upper surface.  We only consider the isothermal, Glen-power-law \citep{GreveBlatter2009} case.  Let $b$ be the bed and $s = H+b$ the ice surface elevation.  In the isothermal SIA the flux $\bq$ is given by
\begin{equation}
\bq = - \Gamma H^{n+2} |\grad s|^{n-1} \grad s  \label{eq:siaflux}
\end{equation}
where $\Gamma = 2 A (\rho g)^n / (n+2)$ is a positive constant derived from the Glen power $n$, the ice softness $A$, the ice density $\rho$, and gravity $g$ \citep{Bueleretal2005}.

The flux in \eqref{eq:siaflux} has multiple interpretations.  Equation \eqref{eq:siaevolution} is usually interpreted as nonlinear diffusion in which
\begin{equation}
\bq = - D \grad s \quad \text{and} \quad D =  \Gamma H^{n+2} |\grad s|^{n-1}. \label{eq:siafluxdiffusion}
\end{equation}
However, if the bed is not flat then $\grad s$ and $\grad H$ are different.  On the other hand one can compute a vertically-averaged velocity $\bV$, and suppose that the flux arises from the transport of the thickness by $\bV$, that is,
\begin{equation}
\bq = \bV H \quad \text{where} \quad \bV = - \Gamma H^{n+1} |\grad s|^{n-1} \grad s. \label{eq:siafluxvelocity}
\end{equation}
In this case \eqref{eq:siaevolution} is, apparently, a hyperbolic conservation equation, but this appearance is superficial because the velocity depends in part on the gradient of the transported quantity.

The former diffusion interpretation \eqref{eq:siafluxdiffusion} is more appropriate in the flat-bed case $b=0$ because in that case \eqref{eq:siaevolution} can be transformed to a $p$-Laplacian diffusion equation \citep{CDDSV}.  In general, however, the diffusion-equation interpretation of \eqref{eq:siaevolution} is obscured by the bed gradient $\grad b$ which is in formula \eqref{eq:siafluxdiffusion} for $D$.  This bed gradient is a barrier to theoretical progress on proving the existence and uniqueness of solutions \citep{JouvetBueler2012} and it generates conservation errors at the ice margin in numerical schemes \citep{JaroschSchoofAnslow2013}.

In this paper we modify a form suggested by \cite{JaroschSchoofAnslow2013}, and write
\begin{equation}
\bq = - D \grad H + \bW H^{n+2},\label{eq:fluxform}
\end{equation}
where $D$ is the same as in \eqref{eq:siafluxdiffusion} and
\begin{equation}
\bW = - \Gamma |\grad s|^{n-1} \grad b.  \label{eq:siaWdefine}
\end{equation}
The vector field $\bW$ should be thought of as a ``velocity'' which transports $H^{n+2}$; compare ``$\boldsymbol{\omega}$'' in equation (19) in \citep{JaroschSchoofAnslow2013}.  Note that $\bW=0$ in the case of flat beds.  The advantage of form \eqref{eq:fluxform} in numerical schemes, over either \eqref{eq:siafluxdiffusion} or \eqref{eq:siafluxvelocity}, is that we can apply a non-oscillatory transport scheme to the ``$\bW H^{n+2}$'' term while preserving accuracy by applying a centered scheme to the full diffusive term ``$-D \grad H$''.

In this paper we solve only the steady-state form of \eqref{eq:siaevolution},
\begin{equation}
\Div \bq = m.  \label{eq:siasteady}
\end{equation}
Though this equation is simpler than \eqref{eq:siaevolution}, it is technically more difficult in the sense that the location where the boundary conditions should be applied is unknown \citep{JaroschSchoofAnslow2013,JouvetBueler2012}, that is, it is a free-boundary problem.  The domain where \eqref{eq:siasteady} applies, and the location of the boundary where $\bq=0$, cannot be treated as a small modification of a known boundary, which is the standard approach with time-stepping schemes \citep{Bueleretal2005,Huybrechtsetal1996}.

To relate numerical solutions of the steady problem \eqref{eq:siasteady} to fully-implicit  solutions of \eqref{eq:siaevolution}, suppose we discretize \eqref{eq:siaevolution} only in time (``semi-discretized'') by the backward Euler method.  Denoting the approximate thickness function at time $t_m$ by $H_m$, we have a problem essentially the same as \eqref{eq:siasteady} to solve at each time-step $\Delta t> 0$:
\begin{equation}
\Delta t\,\Div \bq_m + H_m = H_{m-1} + \Delta t\,m,  \label{eq:siaBE}
\end{equation}
where $\bq_m$ depends on the unknown function $H_m$ by one of the above flux formulas.  If the surface mass balance $m$ is surface elevation independent then the right side of \eqref{eq:siaBE} is known, just like the right side in \eqref{eq:siasteady}.  Solving \eqref{eq:siaBE} can be done by exactly the same kind of spatial discretization and constrained-Newton method as we apply to \eqref{eq:siasteady}.  Both equations should be solved as free boundary problems of ``elliptic'' type \citep{JouvetBueler2012}.

Thus the SIA problem we solve consists of equations \eqref{eq:fluxform} and \eqref{eq:siasteady}, where $D$ and $\bW$ are defined in \eqref{eq:siafluxdiffusion} and \eqref{eq:siaWdefine} respectively.  The input data to this problem consists of the bed elevation $b(x,y)$ and the (steady) surface mass balance $m(x,y)$ defined on some larger domain $\Omega$.  The solution is the nonnegative thickness function $H(x,y)$, and corresponding surface elevation $s(x,y)$.

If $m$ is sufficiently-negative near the boundary of $\Omega$ then $H$ reaches zero inside the domain at a free boundary \citep{JouvetBueler2012}.  This free boundary, at which both $H\to 0$ and $\bq \to 0$, also has degenerate diffusivity $D \to 0$.  Solving equation \eqref{eq:siasteady}, or each time-step equation \eqref{eq:siaBE}, as such a free-boundary problem, without a boundary flux applied along any part of the boundary of $\Omega$, is usually called a ``whole'' ice sheet model, to which we restrict our attention.


\section{The classical Mahaffy scheme}   \label{sec:mahaffyfd}

Consider the FD grid in Figure \ref{fig:fdfemgrids}a.  The Mahaffy scheme calculates the flux $\bq$ at the staggered grid points marked by a triangles in the Figure \cite[equations (19), (20)]{Mahaffy1976}.  Specifically, at $(x_{j+\half},y_k)$ the scheme computes the $x$-component of the flux by
\begin{equation}
q^x_{j+\half,k} = - \Gamma (H_{j+\half,k})^{\,n+2} \alpharight^{\,n-1} \frac{s_{j+1,k} - s_{j,k}}{\Delta x}  \label{eq:mahaffyqx}
\end{equation}
where $s_{j,k} = H_{j,k} + b_{j,k}$ and the staggered-grid value of the thickness is simply the average
\begin{equation}
  H_{j+\half,k} = \frac{H_{j,k} + H_{j+1,k}}{2}.  \label{eq:mahaffyHav}
\end{equation}
The quantity ``$\alpharight$\!'' is an estimate of $|\grad s|$:
\begin{align}
\alpharight^{\,2} &= \left(\frac{s_{j+1,k} - s_{j,k}}{\Delta x}\right)^2  \label{eq:mahaffyalphax} \\
  &\quad + \left(\frac{s_{j,k+1} + s_{j+1,k+1} - s_{j,k-1} - s_{j+1,k-1}}{4 \Delta y}\right)^2. \notag
\end{align}
The formulas for the flux $q^y_{j,k+\half}$, thickness average $H_{j,k+\half}$, and slope estimate $\alphaup$\!, at staggered location $(x_j,y_{k+\half})$, follow by swapping the roles of $j$ and $k$, and $\Delta x$ and $\Delta y$ also, in the above equations.

\begin{figure}[ht]
\begin{center}
\input{fig1a.tikz} \quad \input{fig1b.tikz}
\end{center}
\caption{\textbf{a.}~A structured grid as an FD grid with regular (dots) and staggered (triangles) locations.  \textbf{b.}~The same grid as an FVE grid with rectangular elements $\square_{j,k}$ (solid), nodes (dots), and a dual rectangular control volume $V_{j,k}$ (dashed).}
\label{fig:fdfemgrids}
\end{figure}

Slope approximation \eqref{eq:mahaffyalphax}, and its equivalents for computing slopes $|\grad s|$ at the other locations marked by triangles in Figure \ref{fig:fdfemgrids}a, is the least-obvious aspect of the Mahaffy scheme.  However, the SIA equation \eqref{eq:siasteady} itself is discretized by \cite{Mahaffy1976} using straightforward centered-difference formulas \citep{MortonMayers2005} for the flux divergence:
\begin{equation}
\frac{q^x_{j+1/2,k} - q^x_{j-1/2,k}}{\Delta x} + \frac{q^y_{j,k+1/2}- q^y_{j,k-1/2}}{\Delta y} = m_{j,k}.  \label{eq:siasteadyfd}
\end{equation}

Equation \eqref{eq:siasteadyfd} is one equation in an algebraic system which should determine all values $H_{j,k}$ simultaneously.  Equation \eqref{eq:siasteadyfd} is centered at $(x_j,y_k)$ and it involves all nine unknown values of $H$ at the regular grid points (dots) in Figure \ref{fig:fdfemgrids}a.  We call this pattern of dependence the ``stencil'' of the scheme \citep{MortonMayers2005}.


\section{A finite volume element interpretation} \label{sec:fveinterpretation}

The above description of the Mahaffy FD method is familiar to numerical ice sheet modelers.  We now re-derive the scheme from an FE \emph{and} finite volume (FV; LeVeque, 2002)\nocite{LeVeque} perspective, and we believe this is new.  Our re-interpretation uses the same structured grid, but the regular grid points $(x_j,y_k)$ are now nodes (degrees of freedom) for a continuous space of trial functions.  The same nodes are also used as centered degrees of freedom for (discontinuous) piecewise-constant test functions.  These test functions are discontinuous at the FD method's staggered grid points in particular (Figure \ref{fig:fdfemgrids}).  The method is a ``finite volume element'' method (FVE; Cai, 1990)\nocite{Cai1990} in which exact discrete conservation, and the construction of upwind-type flux components, will follow in the standard FV understanding.  The FE character remains because we will use values of the interpolating trial function, from the interior of the element, in evaluating the finite volume integral.

FIXME FROM HERE Note that formula \eqref{eq:mahaffyqx} computes the normal component of the flux $\bq$ at the center of the right edge of the control volume shown in Figure \ref{fig:fdfemgrids}b.  

To re-derive the scheme we suppose \eqref{eq:siasteady} holds and we take a subregion $V$ of $\Omega$.  By the divergence theorem,
\begin{equation}
  - \int_{\partial V} \bq \cdot \bn\,ds = \int_V m\, dx\,dy, \label{eq:siaasconservation}
\end{equation}
where $\partial V$ denotes the boundary of $V$, $\bn$ is the outward normal unit vector, and $ds$ the length element on the closed curve $\partial V$.  This is simply the integral form of \eqref{eq:siasteady}.

An FVE method supposes that the approximation of the solution, here denoted $H^h$, where the ``$h$'' superscript is traditional for indicating FE approximations \cite{Elmanetal2005}, lies in a finite-dimensional space of continuous functions which are defined everywhere.  In fact, these functions must be sufficiently well-behaved so that the approximate flux $\bq^h$ is defined (almost) everywhere, and can be integrated along curves.  Then integral equation \eqref{eq:siaasconservation} is required to hold for a finite set of volumes $V$, which together tile $\Omega$, and this generates a finite system of nonlinear (algebraic) equations which can be solved by Newton's method, for example (see Section \ref{sec:examples}).  This derivation of the algebraic system uses \eqref{eq:siaasconservation} as an FV method would for solving the differential equation \eqref{eq:siasteady}.  However, we could also let $g(x,y)$ be the characteristic function of $V$ (i.e.~with value one on $V$ and zero otherwise), and then multiply \eqref{eq:siasteadyfd} by $g$ and integrate and derive \eqref{eq:siaasconservation} that way, mimicking the construction of an FE method.

So consider the structured grid of $\Delta x$ by $\Delta y$ rectangles, the ``elements,'' shown in Figure \ref{fig:fdfemgrids}b.  Denote the element with lower-left corner at $(x_j,y_k)$ by $\square_{j,k}$.  These rectangles are true $Q^1$ finite elements when associated with bilinear functions, and a basis for such functions on $\square_{j,k}$ is
\begin{equation}
\chi_l(x-x_j,y-y_k), \label{eq:elementbasis}
\end{equation}
for $l=1,2,3,4$, where
\begin{align*}
\chi_1(x,y) &= \left(1-\frac{x}{\Delta x}\right) \left(1-\frac{y}{\Delta y}\right), & \chi_2(x,y) &= \frac{x}{\Delta x} \left(1-\frac{y}{\Delta y}\right), \\
\chi_3(x,y) &= \left(1-\frac{x}{\Delta x}\right) \frac{y}{\Delta y}, & \chi_4(x,y) &= \frac{x}{\Delta x} \frac{y}{\Delta y}. 
\end{align*}
If $C(\Omega)$ denotes the continuous functions on the domain, then let
\begin{equation}
S_h = \{u \in C(\Omega) \,\big|\, u \text{ is bilinear on each $\square_{j,k}$}\},
\end{equation}
the $Q^1$ finite element space \cite{Elmanetal2005}.  Functions in $S_h$ have a gradient which is defined almost everywhere, but the gradient is discontinuous along the element edges (solid lines in Figure \ref{fig:fdfemgrids}b).

Let $V_{j,k}$ be the rectangular control volume shown by dashed lines in Figure \ref{fig:fdfemgrids}b, with center at $(x_j,y_j)$, also with dimensions $\Delta x$ by $\Delta y$.  If $L^\infty(\Omega)$ denotes bounded and integrable functions on $\Omega$ \cite{Evans}, let
\begin{equation}
S_h^* = \{u \in L^\infty(\Omega) \,\big|\, u \text{ is constant on each $V_{j,k}$}\}.
\end{equation}
Functions in $S_h^*$ are discontinuous along the control volume edges (dashed lines in Figure \ref{fig:fdfemgrids}b).

Those functions which take value one at a single node and are zero at all other nodes form bases of $S_h$ and $S_h^*$, respectively.  Thus, by definition, $\psi_{j,k}(x,y)$ is the unique function in $S_h$ so that $\psi_{j,k}(x_r,y_s) = \delta_{jr} \delta_{ks}$, and $\omega_{j,k}(x,y)$ is the unique function in $S_h^*$  so that $\omega_{j,k}(x_r,y_s) = \delta_{jr} \delta_{ks}$.  See Figure \ref{fig:fembases}.  If index $j$ is in $1,\dots,N_x$ and $k$ is in $1,\dots,N_y$ then there are $N_xN_y$ distinct nodes so $\dim S_h = \dim S_h^* = N_x N_y$.  

\begin{figure}[ht]
\begin{center}
\input{fig2a.tikz} \quad \input{fig2b.tikz}
\end{center}
\caption{{\large \textbf{a.}}~A continuous ``hat'' basis function $\psi_{j,k}(x,y)$ in the $Q^1$ trial space $S_h$.  {\large \textbf{b.}}~A discontinuous, piecewise-constant basis function $\omega_{j,k}(x,y)$ in the test space $S_h^*$.}
\label{fig:fembases}
\end{figure}

We seek an approximate solution $H^h$ from $S_h$.  Let $b^h$ be the piecewise-bilinear interpolant of the bed elevation $b$, thus also in $S_h$, and let $s^h=H^h+b^h$.  We denote by $\bq^h$ the flux computed from formula \eqref{eq:siaflux} using $H^h$ and $b^h$, so that $\bq^h$ is well-defined on the interior of each element.  We require \eqref{eq:siaasconservation} to hold for this $\bq^h$ and all volumes $V_{j,k}$.  (Equivalently, we multiply \eqref{eq:siasteady} by any $\omega_{j,k}$ from the basis for $S_h^*$, and integrate, and require these equations to hold.)  However, we use midpoint quadrature on the right-hand integral in \eqref{eq:siaasconservation}.  Thus we seek $H^h$ in $S_h$ satisfying
\begin{equation}
  - \int_{\partial V_{j,k}} \bq^h \cdot \bn\,ds = m_{j,k}\, \Delta x \Delta y, \label{eq:siafve}
\end{equation}
for all $j,k$.  This equation gives a finite algebraic system once we choose a quadrature rule on the left.  Equation \eqref{eq:siafve} is a typical FV interpretation of equation \eqref{eq:siasteady}, but the FE character remains because $\bq^h$ is defined almost everywhere on $\Omega$, as $H^h$ and $s^h$ are from $S_h$.

We decompose the integral in \eqref{eq:siafve} into the four edges which form $\partial V_{j,k}$.  Let
\begin{equation}
x_j^\pm = x_j \pm \dxtwo, \qquad y_k^\pm = y_k \pm \dytwo, \label{eq:definexypm}
\end{equation}
and denote components $\bq^h = \ip{q^x}{q^y}$, so that
\begin{equation}
  \int_{\partial V_{j,k}} \bq^h \cdot \bn\,ds = \int_{y_k^-}^{y_k^+} q^x(x_j^+,y)\,dy + \int_{x_j^-}^{x_j^+} q^y(x,y_k^+)\,dx - \int_{y_k^-}^{y_k^+} q^x(x_j^-,y)\,dy - \int_{x_j^-}^{x_j^+} q^y(x,y_k^-)\,dx. \label{eq:fluxintdecomp}
\end{equation}
Note $\bq^h$ is a well-defined, bounded function, and continuous on each element $\square_{j,k}$, but it is discontinuous across element boundaries.  For example, in the first integral on the right in \eqref{eq:fluxintdecomp} the integrand $f(y) = q^x(x_j^+,y)$ is piecewise-continuous on the interval of integration $y_k^- \le y \le y_k^+$, but it has a jump discontinuity at the midpoint $y=y_k$ because, though $\grad s^h = \ip{s^h_x}{s^h_y}$ is linear on each element, $s^h_y$ is discontinuous at $y=y_k$.

The Mahaffy scheme computes each integral in \eqref{eq:fluxintdecomp} by the midpoint method, but using the value of the discontinuous component of the surface gradient \emph{computed by averaging across its jump discontinuity}.  Thus Mahaffy does not use a true quadrature, because the integrand $\bq^h\cdot \bn$ does not have a value at the quadrature (mid-) point, but a value is re-constructed.

To turn this idea into formulas, observe that the thickness $H^h$ and the $x$-derivative $s^h_x$ have continuous values between the elements $\square_{j,k}$ and $\square_{j,k-1}$.  Indeed, the components of the surface gradient on the element $\square_{j,k}$ have the formulas
	\begin{comment}
	COMMENT OUT: here is the surface elevation on $\square_{j,k}$
	\begin{align*}
	s^h(x,y) &= s_{j,k} \left(1-\tfrac{x-x_j}{\Delta x}\right) \left(1-\tfrac{y-y_k}{\Delta y}\right)
	    + s_{j+1,k} \left(\tfrac{x-x_j}{\Delta x}\right) \left(1-\tfrac{y-y_k}{\Delta y}\right) \\
	         &\qquad + s_{j,k+1} \left(1-\tfrac{x-x_j}{\Delta x}\right) \left(\tfrac{y-y_k}{\Delta y}\right)
	    + s_{j+1,k+1} \left(\tfrac{x-x_j}{\Delta x}\right) \left(\tfrac{y-y_k}{\Delta y}\right)
	\end{align*}
	\end{comment}
\begin{align}
s^h_x(x,y) &= \frac{s_{j+1,k}-s_{j,k}}{\Delta x} \left(1-\frac{y-y_k}{\Delta y}\right) + \frac{s_{j+1,k+1}-s_{j,k+1}}{\Delta x} \left(\frac{y-y_k}{\Delta y}\right), \label{eq:grads} \\
s^h_y(x,y) &= \frac{s_{j,k+1}-s_{j,k}}{\Delta y} \left(1-\frac{x-x_j}{\Delta x}\right) + \frac{s_{j+1,k+1}-s_{j+1,k}}{\Delta y} \left(\frac{x-x_j}{\Delta x}\right), \notag
\end{align}
and the same functions on $\square_{j,k-1}$ can be calculated by shifting the index $k\to k-1$.  Thus $s^h_x(x,y)$ is continuous on the interval of integration in the first integral in \eqref{eq:fluxintdecomp}, and at the midpoint it has value
\begin{equation}
s^h_x(x_j^+,y_k) = \frac{s_{j+1,k}-s_{j,k}}{\Delta x}. \label{eq:femsxstag}
\end{equation}
Similarly, writing-out $H^h(x,y)$ on each element, using the element basis \eqref{eq:elementbasis}, and evaluating at the midpoint in the first integral in \eqref{eq:fluxintdecomp} gives
\begin{equation}
H^h(x_j^+,y_k) = \frac{H_{j,k}+H_{j+1,k}}{2}, \label{eq:femHstag}
\end{equation}

However, the $y$-derivative has different values above (i.e.~on $\square_{j,k}$) and below (on $\square_{j,k-1}$) the element boundary at $y = y_k$; the limits are:
\begin{align}
s^h_y(x_j^+,y_k+0) = \frac{s_{j,k+1}-s_{j,k} + s_{j+1,k+1}-s_{j+1,k}}{2\Delta y}, \\
s^h_y(x_j^+,y_k-0) = \frac{s_{j,k}-s_{j,k-1} + s_{j+1,k}-s_{j+1,k-1}}{2\Delta y}. \notag
\end{align}
The average of these values is thus not a value of $s_y^h$, but a good re-construction thereof:
\begin{equation}
\widehat{s^h_y}(x_j^+,y_k) = \frac{s_{j,k+1} + s_{j+1,k+1} - s_{j,k-1} - s_{j+1,k-1}}{4\Delta y}. \label{eq:femsystagcrime}
\end{equation}
The hat in \eqref{eq:femsystagcrime} indicates that it is \emph{not} a result of evaluating $s^h_y(x,y)$, but formula \eqref{eq:femsystagcrime} is exactly the estimate of $\partial s/\partial y$ which appears in FD formula \eqref{eq:mahaffyWalphax}.

In our FVE interpretation, we see that the Mahaffy scheme uses \eqref{eq:femsxstag}, \eqref{eq:femHstag}, and \eqref{eq:femsystagcrime} in the midpoint rule:
\begin{equation}
\int_{y_k^-}^{y_k^+} q^x(x_j^+,y)\,dy \approx - \Gamma H^h(x_j^+,y_k)^{n+2} \left(s^h_x(x_j^+,y_k)^2 + \widehat{s^h_y}(x_j^+,y_k)^2\right)^{(n-1)/2} s^h_x(x_j^+,y_k)\,\Delta y. \label{eq:femmahaffyfirstint}
\end{equation}
Mahaffy thus approximates each integral on the right in \eqref{eq:fluxintdecomp} by a smart quadrature ``crime'' (compare \cite{Strang1972}), averaging across discontinuities to reconstruct slopes.  Approximation \eqref{eq:femmahaffyfirstint}, and the corresponding approximations of the other integrals in \eqref{eq:fluxintdecomp}, gives the same approximations of the staggered-grid fluxes as \eqref{eq:mahaffyWqx}, \eqref{eq:mahaffyWalphax}, \eqref{eq:mahaffyWqy}, and \eqref{eq:mahaffyWalphay}.  In particular, dividing the resulting approximation of equation \eqref{eq:siafve} by the control volume area $\Delta x\,\Delta y$ gives FD equation \eqref{eq:siasteadyfd}.

\section{An improved scheme on structured and unstructured grids}  \label{sec:star}

If our goal is to convert FVE equation \eqref{eq:siafve} into an algebraic equation by a choice of quadrature along the boundary of the control volume ($\partial V_{j,k}$), it is easy to propose a straightforward improvement over the Mahaffy scheme of the previous section.  To recap the situation, because $H^h$ and $s^h$ live in the $Q^1$ space of continuous, piecewise-bilinear functions $S_h$, the numerical approximation $q^h$ from formula \eqref{eq:siaflux} is defined on the interior of each element.  However, because the gradient $\grad s^h$ is discontinuous across the element boundaries, also $\bq^h$ is discontinuous across element boundaries.

Because of the discontinuity of the integrand on the element boundary, we break each interval of integration on the right-hand side of \eqref{eq:fluxintdecomp} into two parts, so that we are integrating smooth functions.  For example, we break the first integral on the right-hand side of \eqref{eq:fluxintdecomp} at $y=y_k$.  Then we use the midpoint rule, which is the optimal one-point rule for smooth functions, in each subinterval; recall notation \eqref{eq:definexypm}:
\begin{align}
  \int_{y_k^-}^{y_k^+} q^x(x_j^+,y)\,dy &= \int_{y_k^-}^{y_k} q^x(x_j^+,y)\,dy + \int_{y_k}^{y_k^+} q^x(x_j^+,y)\,dy \label{eq:starbreakfirst} \\
      &\approx \frac{\Delta y}{2} \left(q^x(x_j^+,y_k-\tfrac{\Delta y}{4}) + q^x(x_j^+,y_k+\tfrac{\Delta y}{4})\right). \notag
\end{align}
The values $q^x(x_j^+,y_k\pm\tfrac{\Delta y}{4})$ are straightforwardly-evaluated by computing $q^x(x,y)$ on the appropriate element.  Given that we index so that element $\square_{j,k}$ has lower-left corner $(x_j,y_k)$, however, note that $(x_j^+,y_k+\tfrac{\Delta y}{4})$ is a point in element $\square_{j,k}$ while $(x_j^+,y_k-\tfrac{\Delta y}{4})$ is a point in element $\square_{j,k-1}$.  Similar formulas apply to the other three integrals on the right-hand side of \eqref{eq:fluxintdecomp}.

We call this method the ``\Mstar'' method.  Figure \ref{fig:mahaffystar} shows all eight quadrature points needed to compute the full integral over $\partial V_{j,k}$ in \eqref{eq:siafve}.  Clearly the method requires evaluating $\bq^h(x,y)$ at four locations in each element.  In the sense that the Mahaffy method itself (section \ref{sec:fveinterpretation}) requires evaluating the flux at the midpoint of every side of every element, it also requires evaluating the flux at four locations in each element.  However, the total number of flux-evaluations per node is two times larger for \Mstar than for Mahaffy.  The stencils for the two methods are the same in the sense that in both methods equation \eqref{eq:siafve} uses the nine nodal values of $H^h$ and $b^h$ (solid dots in Figure \ref{fig:mahaffystar}).

\begin{figure}[ht]
\begin{center}
\input{fig3.tikz}
\end{center}
\caption{To compute the integral in equation \eqref{eq:siafve} the \Mstar method evaluates the $Q^1$ approximation of the flux $\bq^h(x,y)$ at eight locations (circles) along $\partial V_{j,k}$.}
\label{fig:mahaffystar}
\end{figure}

Indeed, eight half-edges make up $\partial V_{j,k}$, with each half-edge entirely inside an element.  Along each half-edge the $Q^1$ approximation $\bq^h$ is smooth.  Thus one could propose improved-quadrature methods, beyond \Mstar, which replace the midpoint rule by the 2-point Gauss-Legendre quadrature (thus 2 flux evaluations per half-edge, and 16 evaluations along $\partial V_{j,k}$), Simpson quadrature (3 and 24 evaluations), or other quadrature methods.  Such methods have not been tested.  Also, the $Q^1$ elements considered in this paper could be replaced by higher-order $Q^2$ elements, and so on.  However, the largest numerical errors when solving the SIA occur near the free boundary, namely at the ice sheet margin \cite{Bueleretal2005}.  At such locations the exact solution $H$ has low regularity (compare \cite{JouvetBueler2012}), and any FE method of any order suffers in the sense that the exact free boundary may pass through an element.  Because $\bq^h$ represents a smooth approximation on the element to a merely-continuous (and not smooth) exact flux $\bq$, on such free boundary elements, higher-order quadratures will probably not give much advantage.  The \Mstar method represents a measurable improvement over the Mahaffy method (see the next section) primarily because the quadrature method in \Mstar uses true evaluations of the flux approximation $\bq^h$.

FIXME: the same \Mstar idea can be extended to dual Delaunay/Voronoi meshes (e.g.~the meshes from \cite{EgholmNielsen2010,Ringleretal2013}) using $P^1$ elements on the Delaunay triangulation, and doing quadrature on the Voronoi-cell edges by splitting these edges where the element (i.e.~triangle) boundaries cross (perpendicularly) the Voronoi-cell edges.  This improves on the \cite{EgholmNielsen2010} method by exploiting an underlying $P^1$ element approximation to approximate the flux, instead of using the moving least squares method.


\section{Computed examples} \label{sec:examples}

FIXME: code \texttt{petsc/mahaffy.c} implements \Mstar and Mahaffy methods; verification relative to steady part of Test D from \cite{Bueleretal2005}, i.e.~``Bueler profile'' from \cite{vanderVeen2013}; at low res we see \Mstar is more accurate at points along margin; at high res \Mstar is slightly better for convergence

FIXME: add whole Greenland model; compute \Mstar SIA solution with present-day climate in one step on fairly high res (2km?)


\section{Conclusion} \label{sec:conclusion}

FIXME: The first idea in the paper is that a FVE interpretation is compatible with the original Mahaffy FD scheme.  The second idea is that the flux approximation is discontinuous along element edges, so, in evaluating the quadrature along the boundary of the control volume, there is either a doubling of the range over which derivatives are evaluated (Mahaffy) or a doubling of the number of quadrature points (\Mstar).  The new \Mstar method is slightly more accurate, especially at coarse resolution, and easier to understand and implement in a $Q^1$ FE world.  The computed examples using this method are novel, except for \cite{JouvetBueler2012}, by going directly to steady state from zero ice.

\section*{Acknowledgements}
This work was supported by NASA grant \#NNX13AM16G and a grant of high-performance computing resources from the Arctic Region Supercomputing Center.


%         References
\bibliography{../layerpaper/lc}
\bibliographystyle{igs}


\begin{comment}
Here is what the MPAS Land-Ice User's Manual version 3.0 says:

\begin{quote}
\small
Velocities and fluxes are calculated on the midpoint of Voronoi cell edges.  The normal component of surface slope is calculated on cell edges using surface elevation at adjacent cell centers.  The tangential component of surface slope is calculated on cell edges using surface elevation at adjacent vertices. The surface elevation at vertices is calculated from the values at adjacent cell centers using barycentric interpolation. Ice thickness on edges is calculated as the average of the adjacent cell center values (2nd-order approximation).
\end{quote}

Looking at this, and the code, I don't think they think of it as Petrov-Galerkin
\end{comment}


\end{document}
