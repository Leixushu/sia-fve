\documentclass[final,leqno,onefignum,onetabnum]{siamltex1213bueler}
% siamltex1213bueler.cls is a two or three line change of siamltex1213.cls to permit
% pdflatex to work and not spew warnings

\usepackage{amssymb,amsmath}

\usepackage{times}

%\theoremstyle{definition}
\newtheorem{example}{Example}
%\newtheorem*{examplecont}{Example, continued}

% math macros
\newcommand\bb{\mathbf{b}}
\newcommand\bbf{\mathbf{f}}
\newcommand\bn{\mathbf{n}}
\newcommand\bq{\mathbf{q}}
\newcommand\bu{\mathbf{u}}
\newcommand\bv{\mathbf{v}}
\newcommand\by{\mathbf{y}}

\newcommand\bQ{\mathbf{Q}}
\newcommand\bV{\mathbf{V}}
\newcommand\bX{\mathbf{X}}

\newcommand\CC{\mathbb{C}}
\newcommand{\DDt}[1]{\ensuremath{\frac{d #1}{d t}}}
\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}
\newcommand{\ddx}[1]{\ensuremath{\frac{\partial #1}{\partial x}}}
\newcommand{\ddy}[1]{\ensuremath{\frac{\partial #1}{\partial y}}}
\newcommand{\ddxp}[1]{\ensuremath{\frac{\partial #1}{\partial x'}}}
\newcommand{\ddz}[1]{\ensuremath{\frac{\partial #1}{\partial z}}}
\newcommand{\ddxx}[1]{\ensuremath{\frac{\partial^2 #1}{\partial x^2}}}
\newcommand{\ddyy}[1]{\ensuremath{\frac{\partial^2 #1}{\partial y^2}}}
\newcommand{\ddxy}[1]{\ensuremath{\frac{\partial^2 #1}{\partial x \partial y}}}
\newcommand{\ddzz}[1]{\ensuremath{\frac{\partial^2 #1}{\partial z^2}}}
\newcommand{\Div}{\nabla\cdot}
\newcommand\eps{\epsilon}
\renewcommand{\grad}{\nabla}
\newcommand{\ihat}{\mathbf{i}}
\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}
\newcommand{\jhat}{\mathbf{j}}
\newcommand{\khat}{\mathbf{k}}
\newcommand{\nhat}{\mathbf{n}}
\newcommand\lam{\lambda}
\newcommand\lap{\triangle}
\newcommand\Matlab{\textsc{Matlab}\xspace}
\newcommand\RR{\mathbb{R}}
\newcommand\vf{\varphi}

\title{Conservation for fluid layers with free boundaries\thanks{Draft date: \today.  Supported by NASA grant \# NNX13AM16G.}} 

\author{Ed Bueler\thanks{Dept.~of Mathematics and Statistics, and Geophysical Institute, University of Alaska Fairbanks (\texttt{elbueler@alaska.edu}).}}

\begin{document}
\maketitle
\slugger{siap}{xxxx}{xx}{x}{x--x}%slugger should be set to mms, siap, sicomp, sicon, sidma, sima, simax, sinum, siopt, sisc, or sirev

\begin{abstract}
FIXME
\end{abstract}

%\begin{keywords}\end{keywords}

%\begin{AMS}\end{AMS}


\pagestyle{myheadings}
\thispagestyle{plain}
\markboth{ED BUELER}{CONSERVATION FOR FLUID LAYERS WITH FREE-BOUNDARIES}


\section{Introduction}  \label{sec:intro}

Consider a fluid which moves over a solid substrate.  Suppose that mass can be added or removed at the boundary of the three-dimensional fluid region, either by a process like precipitation or aggregation, or by phase change if we define the fluid region as being only a single phase.  (We describe all such addition/removal at the boundary as ``boundary sources.'')  Through both flow and boundary sources, the region occupied by the fluid changes in time, thus the problem is of moving-boundary type.  Of course there is nothing special about ``mass'' in the above.  Can a numerical model of such free-boundary fluid motion, with non-material boundary surfaces, conserve a discretized property of the fluid, such as mass, momentum, or energy, exactly?

In this paper we restrict the question to models which describe the fluid by a \emph{layer thickness}, typically by integrating in one direction (e.g.~vertically along gravity).  In such models the boundary sources become actual source terms in a conservation equation.  Generally the domain on the substrate where the fluid layer is present, i.e.~where its thickness is positive, changes in time, so the problem is of free-boundary type.  The layer always occupies a subset of a larger fixed region, however.  We also consider only conservation of scalar properties, which we revert to calling ``mass.''  In the layer models the thickness is the conserved quantity, equivalent to mass.

Fluid simulation codes and climate models are obliged to discretize time in some manner.  Our approach is to semi-discretize the problem in time by a one-step method and pose the single time-step problem in weak variational form.  (Multi-stage but one step time-discretization methods, such as Runge-Kutta methods, are also considered; see the Appendix.)  A rich selection of methods, including finite difference/volume/element methods and grid free spectral methods, are possible when discretizing space, but our approach will be independent of the chosen spatial discretization.

Our question is this:
  \begin{quote}
  \emph{Can the discrete, modeled mass of a fluid with free boundary, given source terms defined everywhere in a larger, fixed region including the fluid, be conserved exactly in the sense that computable space-time integrals of the source terms over the changing fluid region, and over one time step, equal the change in discrete mass in that time step?}
  \end{quote}

Free-boundary problems of kind we consider appear for the evolution of ice sheets \cite{BLKCB,CDDSV,EgholmNielsen2010,JouvetBueler2012}, shallow liquid water flowing over marshes \cite{AlonsoSantillanaDawson}, coupled surface/subsurface hydrological modelling \cite{Maxwelletal2014}, [Dupuit-Forchheimer APPROX IN GROUNDWATER], subglacial hydrology \cite{AschwandenBuelerKhroulevBlatter,BuelervanPeltDRAFT,Schoofetal2012}, supraglacial runoff \cite{AschwandenBuelerKhroulevBlatter}, sea ice (?), and tsunami run-up (?), among many other applications.

However, we believe that theoretical guidance as to the achievability of exact discrete conservation is generally absent in such literature of free-boundary fluid problems.  For instance, within the context of glacier \cite{JaroschSchoofAnslow2013} and ice shelf \cite{Albrechtetal2011} modeling, schemes for improved discrete mass conservation at free boundaries are proposed, but this small literature succeeds in suggesting the difficulty of the problem while providing only \emph{ad hoc} solutions at the discrete level.  Literature addressing local discrete conservation within the fluid, e.g.~\cite{Lengetal2014} for finite element ice sheet models, also exists, but in our context we will assume such local discrete conservation is already exact.  Our interest is at the free boundary.  In fact, we focus on the advance of the fluid layer into areas where it was absent a time-step earlier, and on its retreat from areas where it was present a time-step earlier.

The literature of climate-scale circulation models generally claims exact discrete conservation as a goal [FIXME: CITE], but apparently always in a context without free boundary.  Such climate models are ``multiphysics'' models which generally attempt to conserve masses of the phases of water (in particular) separately, as these phases have different physical properties relevant to earth system dynamics.  For example, snow and ice have higher albedo than liquid ocean, and different densities as well.  In some such models there is at least one fluid having a moving free boundary.  We believe that auditable mass conservation does not generally occur in that case, except perhaps through \emph{ad hoc} redistribution of mass, or \emph{ad hoc} discrete schemes to locally balance the books at the free boundary.

As noted above, the single time-step problem is put in weak form.  More specifically it is a variational inequality.  The nonnegativity of thickness provides the constraint, determining a closed, convex subset of a Banach space of admissible thickness functions.  The constraint is active when negativity of the source term would otherwise send the thickness below zero.

We identify the ``retreat area'' during the time step as fundamental.  By definition this area is the set where the fluid layer thickness is positive at the beginning of the time step, and, through flow and boundary-source terms, the thickness is zero at the end of the time step.  That is, fluid was completely lost from the retreat area at some time during the time-step.  Even for well-behaved source terms (e.g.~smooth in time and space) and short time steps, the retreat area can be of essentially arbitrary size.  For example, in a varying climate a large area of thin ice sheet or sea ice can melt, or a large area of a layer of surface water on ground can evaporate, in the duration of one time step, no matter how short.

We define the ``retreat loss'' as the change in mass during the time step within the retreat area.  In terms of this quantity can state our major assertions informally:\begin{itemize}
\item  \emph{The retreat loss cannot be \emph{exactly} balanced by a \emph{modeled} source during the discrete time-step.}
\item  \emph{A time-stepping model which claims auditable mass conservation must track and report a retreat loss time-series additional to any integrals of the source terms.}
\end{itemize}

We believe that the avoidance of \emph{ad hoc} discrete schemes will be easieronce theoretical limits on discrete conservation are acknowledged, as here.  With the retreat area correction term identified here, for example, when a large area of ice sheet or sea-ice melts then the discrete-time model will can report accurately on the degree of conservation of the mass of water in all phases.  Generally climate models will be able to more accurately report scientificially-essential mass transfers between the phases, as the phases occupy changing regions.


\section{Continuous-time strong formulation}  \label{sec:strongform}

Let $\Omega \subset \RR^d$ be a bounded open region with sufficiently-regular boundary.  The time-dependent model we consider is usually stated in strong form as follows.  It combines a conservation equation, a flux (Neumann) boundary condition, and a constraint:
\begin{align}
u_t + \Div \bq &= f(u,x,t) &&\text{in } \Omega, \text{ where } u > 0 \label{eq:massconserve} \\
\bq \cdot \bn &= g(u,x,t) &&\text{on } \partial\Omega, \text{ where } u > 0 \label{eq:fixedneumann} \\
u &\ge 0 &&\text{in } \bar\Omega. \label{eq:constraint}
\end{align}
We call the unknown $u$ the \emph{layer thickness} $u(x,t)$, and it is defined for $x\in \Omega$ and $t>0$.  The form of the flux $\bq$, that is, how it depends on the unknown $u$ or its gradient $\grad u$, is general for now,
\begin{equation}
\bq = \bq(\grad u,u,x,t), \label{eq:fluxdepends}
\end{equation}
but with more detail below in section \ref{sec:fluxassumptions}.

Constraint \eqref{eq:constraint} comes from the meaning of $u$ as a thickness, which cannot be negative.  We will consider cases where the solution $u$ is continuous (see section \ref{sec:weakform} below, where $u\in W^{1,p}(\Omega)$ with $p>d$), so that the time-dependent support of $u$, namely
   $$\supp u = \{x \big| u(x,t) > 0\} \subset \Omega,$$
is an open set.  We say that the layer exists for $x\in \supp u$, and that it is absent otherwise, though of course $u(x)=0$ is defined for $x\notin \supp u$.  Finding the evolution of this support, and of its free boundary, is essential to problems of this type.

Conservation equation \eqref{eq:massconserve} only applies in this strong form where the layer exists.  Similarly the boundary condition \eqref{eq:fixedneumann} only make sense in locations where $u>0$, at least in the generic case $g\ne 0$.  Well-posedness of the problem \eqref{eq:massconserve}--\eqref{eq:constraint} in fact requires a weak formulation, in which these caveats are replaced by a precise specification of admissible functions, as we do in sections \ref{sec:fluxassumptions} and \ref{sec:weakform}.


\section{Discrete-time strong formulation and associated set decomposition}  \label{sec:discreteform}

We work with the time-semi-discretized problem.  Let $\{t_n\}_{n=0}^N$ be a sequence of increasing times on an interval $[0,T]$ with $t_0=0$ and $t_N=T$.  The \emph{single time-step} problem determines $u_n(x) \approx u(x,t_n)$ given old values $u_{n-1}(x)$.

Though the weak form of this problem, stated in section \ref{sec:weakform} below with attention to function spaces and well-posedness, is more fundamental, both tradition and the developed intuition of practicioners suggests we should state the strong form of the single time-step problem first.  Note that essentially all climate-relevant literature uses the strong (PDE) form rather than variational statements of the type we prefer.

Corresponding to \eqref{eq:massconserve}--\eqref{eq:constraint}, the single-time-step strong form is
\begin{align}
\frac{u_n - u_{n-1}}{\Delta t} + \Div \bQ_n(\grad u_n,u_n,x) &= F_n(u_n,x) &&\text{in } \Omega, \text{ where } u_n > 0 \label{eq:semimassconserve} \\
\bQ_n(\grad u_n,u_n,x) \cdot \bn &= G_n(u_n,x) &&\text{on } \partial\Omega, \text{ where } u_n > 0 \label{eq:semifixedneumann} \\
u_n &\ge 0 &&\text{in } \overline{\Omega} \label{eq:semiconstraint}
\end{align}
In equations \eqref{eq:semimassconserve}--\eqref{eq:semiconstraint}, the functions
\begin{equation}
\bQ_n(\bX,v,x), \quad F_n(v,x), \quad G_n(v,x)\label{eq:functionalforms}
\end{equation}
come from the semi-discretization procedure, where $\bX\in\RR^d$ is any vector, $v\in\RR$, and $x\in \Omega$.  Note that we assume $\bQ_n(\bX,v,x)$ is defined for any $v\in\RR$, not just $v\ge 0$, and for all $x\in\Omega$, not just where $v(x)>0$.

For example, namely in the simplest implicit case, a backward Euler scheme applied to \eqref{eq:massconserve}--\eqref{eq:constraint}, we have $\bQ_n = \bq(\bX,v,x,t_n)$, $F_n = f(v,x,t_n)$, and $G_n = g(v,x,t_n)$.

However, according to the particular discretization procedure, the source function $F_n$ ``absorbs'' all the terms, whether evaluated at $t_{n-1}$ or $t_n$, which do not involve the flux $\bq$ evaluated at time $t_n$.  For example, and including the backward Euler case above, consider a $\theta$-method discretization of \eqref{eq:massconserve} with $0\le \theta \le 1$.  The result is
\begin{align}
  &\frac{u_n - u_{n-1}}{\Delta t} + \theta\, \Div \bq(\grad u_n,u_n,x,t_n) + (1-\theta) \Div \bq(\grad u_{n-1},u_{n-1},x,t_{n-1}) \label{eq:thetamethod} \\
  &\qquad =  \theta f(u_n,x,t_n) + (1-\theta) f(u_{n-1},x,t_{n-1}). \notag
\end{align}
This is of form \eqref{eq:semimassconserve} with
\begin{align*}
\bQ_n(\bX,v,x) &= \theta\, \bq(\bX,v,x,t_n), \\
F_n(v,x)       &= \theta f(v,x,t_n) + (1-\theta) f(u_{n-1},x,t_{n-1}) \\
               &\qquad - (1-\theta) \Div \bq(\grad u_{n-1},u_{n-1},x,t_{n-1}),
\end{align*}
where the already-computed function $u_{n-1}(x)$ represents a portion of the dependence on $x$.

The $\theta=0$ case of \eqref{eq:thetamethod} is the (forward) Euler method, $\theta=1/2$ is the trapezoidal rule, and $\theta=1$ is the backward Euler method.  The fact that $\bQ_n=0$ in the Euler method is completely-acceptable in our weakly-posed theory (Section \ref{sec:weakform}).  Naturally, however, we often include some implicitness for stability reasons.

Our theory is not limited to the $\theta$-methods.  In particular, multi-stage one-step schemes like Runge-Kutta can be put in the form of \eqref{eq:semimassconserve}---see Appendix.

To precisely restate the major assertion of section \ref{sec:intro} we decompose $\Omega$ using the solution of problem \eqref{eq:semimassconserve}--\eqref{eq:semiconstraint}.   We define three disjoint regions based on $u_n$ and $u_{n-1}$:
\begin{align*}
\Omega_n &= \left\{x \in \Omega \,\big|\, u_n(x)>0\right\}, \\
\Omega_n^r &= \left\{x \in \Omega \,\big|\, u_n(x)=0 \text{ and } u_{n-1}(x) > 0\right\}, \\
\Omega_n^0 &= \left\{x \in \Omega \,\big|\, u_n(x)=0 \text{ and } u_{n-1}(x) = 0\right\},
\end{align*}
so that
\begin{equation}
\Omega = \Omega_n \cup \Omega_n^r \cup \Omega_n^0.  \label{eq:omegadecomposition}
\end{equation}
Here the superscript ``$r$'' stands for ``retreat,''\footnote{At this point a symmetry has been broken.  We could have decomposed $\Omega= \Omega_n \cup \Omega_n^a \cup \Omega_n^0$ where $\Omega_n^a = \{u_n(x) > 0 \text{ and } u_{n-1}(x) = 0\}$ is the ``advance'' set.  As far as we can tell the resulting alternate theory offers no advantages or disadvantages.} and $\Omega_n^r$ is called the \emph{retreat set}.  Figure \ref{fig:domains} shows this decomposition of $\Omega$.

\begin{figure}[ht]
\begin{center}
\includegraphics[width=2.0in,keepaspectratio=true]{domains-fig}
\end{center}
\caption{We decompose $\Omega = \Omega_n \cup \Omega_n^r \cup \Omega_n^0$, where $\Omega_n$ the support of $u_n$, $\Omega_n^r$ is the retreat set, and $\Omega_n^0$ is the set on which both $u_{n-1}$ and $u_n$ are zero.  The boundary of $\Omega_n$ is decomposed into two pieces, $\partial\Omega_n = \Gamma_n^N \cup \Gamma_n^0$.}
\label{fig:domains}
\end{figure}

A decomposition of the boundary of the support of $u_n$, i.e.~of the subregion $\Omega_n$, is also shown in Figure \ref{fig:domains}.  The boundary of $\Omega_n$ decomposes disjointly into the part where a fixed (Neumann) condition applies, and a part which is the free boundary.  Let $\Gamma_n^0 = \Omega \cap \partial \Omega_n$ and $\Gamma_n^N = \partial \Omega \cap \partial \Omega_n$, where superscript ``$N$'' stands for ``Neumann.''  Then
\begin{align*}
\partial\Omega_n &= \Gamma_n^N \cup \Gamma_n^0
\end{align*}
Along $\Gamma_n^N$ the flux condition \eqref{eq:semifixedneumann} applies.

At this point the strong form of the single time-step problem is not complete.  In particular, though we have specified the PDE \eqref{eq:semimassconserve} which applies on the set where its solution $u_n$ is positive (i.e.~on $\Omega_n$), in this (inadequate) strong formulation we can also specify behavior on the complement where $u_n=0$ (i.e.~on $\Omega_n^r \cup \Omega_n^0$).  This ``behavior'' is in the form of inequalities.

First we rewrite \eqref{eq:semimassconserve} as
    $$u_n = u_{n-1} + \Delta t\, F_n - \Delta t\, \Div \bQ_n.$$
If $u_n=0$ then the terms on the right must, apparently, either sum to zero or be negative, as otherwise they should be balanced by a positive value for $u_n$; the alternative $u_n<0$ is not allowed because $u_n$ is a thickness.  Note furthermore that, at least intuitively, the flux of a zero-thickness layer should be zero: $\bQ_n=0$ on $\Omega_n^r \cup \Omega_n^0$; see Section \ref{sec:fluxassumptions}.  Thus, $u_{n-1}+\Delta t\, F_n \le 0$ on $\Omega_n^r \cup \Omega_n^0$.  However, because $u_{n-1}\ge 0$ and $\Delta t\ge 0$, we have
\begin{equation}
F_n(u_n,x) \le 0 \quad \text{ and } \quad u_{n-1} + \Delta t\, F_n(u_n,x) \le 0 \quad \text{ on } \Omega_n^r \cup \Omega_n^0. \label{eq:strongconditionswherezero}
\end{equation}
These inequalities will be used to derive the weak form.  (We can also state the contrapositive of \eqref{eq:strongconditionswherezero}: if $F_n>0$ then $u_n>0$, though this does not refer to the above set decomposition.)


\section{Flux assumptions} \label{sec:fluxassumptions}

If $v \in W^{1,p}(\Omega)$ then, for $1/p + 1/q = 1$, we assume
\begin{equation}
\bQ_n(\grad v,v,x) \in L^q(\Omega). \label{eq:QisLq}
\end{equation}
Also, if $v(x)>0$ on an open subset $S\subset \Omega$, and if $v\in C^1(S)$ then we assume
\begin{equation}
\frac{\partial}{\partial x_i} \bQ_n(\grad v,v,x) \in L^q(S). \label{eq:Qissmooth}
\end{equation}

For fixed $\bX\in\RR^d$ and $x\in \Omega$, we assume $\bQ_n(\bX,v,x)$ is continuous in $v\in\RR$, and we assume
\begin{equation}
\bQ_n(\bX,0,x)=0. \label{eq:Qiszero}
\end{equation}

Finally we assume a maximum principle property: for every smooth $v(x)$ on $\Omega$, if $\alpha>0$ then
\begin{equation}
v(x) + \alpha\, (\Div \bQ_n)(\grad v,v,x) > 0 \quad \implies \quad v(x) > 0 \label{eq:maxprincQn}
\end{equation}
for all $x\in\Omega$.

Thus we make three basic assumptions about the discrete-time flux $\bQ_n(\grad u,u,x)$: \begin{itemize}
\item the flux is regular (i.e.~continuity in second argument and assumptions \eqref{eq:QisLq} and \eqref{eq:Qissmooth}),
\item the flux is zero if the thickness is zero (equation \eqref{eq:Qiszero}), and
\item the flux satisfies a maximum principle (assumption \eqref{eq:maxprincQn}).
\end{itemize}

FIXME: Assume the flux boundary condition $G_n$ is regular (i.e.~in $L^\infty(\partial\Omega)$ and H\"older in $u$.  We can extend $G_n$ by zero to the whole of $\partial \Omega$ and not change anything.  On the flip side, as a modeler you are free to put $G_n$ zero anywhere on the boundary, but if it is nonzero then it must be that the solution $u_n$ is actually positive on that part of the boundary


\section{Weak formulation of a time-step ($u_n\in W^{1,p}(\Omega)$ case)}  \label{sec:weakform}

The strong form \eqref{eq:semimassconserve}--\eqref{eq:semiconstraint} is generally understood to be inadequate as a description of the solution function $u_n$ because the behavior of $u_n$ along free boundary $\partial\Omega_n$ is not clear.  Also, statements \eqref{eq:strongconditionswherezero}, while intuitively correct, require defining sets (e.g.~$\Omega_n$ and its complement $\Omega_n^r \cup \Omega_n^0$) in terms of the solution to the problem we are attempting to state.

Instead, in this section we specify function spaces and we propose a weak form of the single time-step problem, namely a variational inequality \cite{Friedman,KinderlehrerStampacchia} on a convex space of admissible functions.  This weak form refers only to the set $\Omega$ and its boundary, not to the sets of the decomposition \eqref{eq:omegadecomposition}.

We start by arguing that a solution to the discrete-time strong problem will be a solution to a certain variational inequality; thereby we find the variational inequality.  Our argument uses both the equations  \eqref{eq:semimassconserve}--\eqref{eq:semiconstraint} from the strong problem and the facts \eqref{eq:strongconditionswherezero}.

\medskip
\begin{theorem} Suppose $u_n\ge 0$ and $v\ge 0$ are continuous on $\overline{\Omega}$ and that $\grad u_n,\grad v$ are in $L^p(\Omega)$.  Suppose that the sets $\Omega_n$, $\Omega_n^r$, $\Omega_n^0$ in decomposition \eqref{eq:omegadecomposition} are all sufficiently smooth (e.g.~Lipshitz).  Suppose $u_n$ solves \eqref{eq:semimassconserve} and \eqref{eq:semifixedneumann} where $u_n>0$.  Suppose the function $\bQ_n(\bX,v,x)$ satisfies assumptions \eqref{eq:QisLq}, \eqref{eq:Qissmooth}, and \eqref{eq:Qiszero}.  Define $\bQ_n=\bQ_n(\grad u_n,u_n,x)$ and $F_n = F_n(u_n,x)$.  Then
\begin{equation}
-\int_{\Omega} \bQ_n \cdot \grad(v-u_n) \ge \int_{\Omega} \left(F_n - \frac{u_n - u_{n-1}}{\Delta t}\right) (v-u_n) - \int_{\partial \Omega} G_n (v-u_n). \label{eq:morallytheVI}
\end{equation}
\end{theorem}

\begin{proof}
Using decomposition \eqref{eq:omegadecomposition} and integration by parts (divergence theorem), which is possible by assumption \eqref{eq:Qissmooth} on $S=\Omega_n$ and $S=(\Omega_n^r \cup \Omega_n^0)^\circ$, we get
\begin{align*}
-\int_{\Omega} \bQ_n \cdot \grad(v-u_n) &= \int_{\Omega_n} (\Div \bQ_n) (v-u_n) - \int_{\partial \Omega_n} (\bQ_n \cdot \bn) (v-u_n) \\
  &\qquad\quad + \int_{\Omega_n^r \cup \Omega_n^0} (\Div \bQ_n) (v-u_n) - \int_{\partial(\Omega_n^r \cup \Omega_n^0)} (\bQ_n \cdot \bn) (v-u_n).
\end{align*}
Because $u_n$ is continuous, $u_n=0$ along $\Gamma_n^0$.  It then follows from \eqref{eq:Qiszero} and equation \eqref{eq:semifixedneumann} that
       $$\int_{\partial \Omega_n} (\bQ_n \cdot \bn) (v-u_n) = \int_{\Gamma_n^N} G_n (v-u_n) = \int_{\partial \Omega} G_n (v-u_n).$$
(For the last equality, recall we extend $G_n$ by zero to all of $\partial \Omega$.)
Similarly,
       $$\int_{\partial(\Omega_n^r \cup \Omega_n^0)} (\bQ_n \cdot \bn) (v-u_n) = 0.$$
By using \eqref{eq:semimassconserve} we get
\begin{align}
-\int_{\Omega} \bQ_n \cdot \grad(v-u_n) &= \int_{\Omega_n} \left(F_n - \frac{u_n - u_{n-1}}{\Delta t}\right) (v-u_n) - \int_{\partial \Omega} G_n (v-u_n) \label{eq:equalitybeforeVI} \\
  &\qquad\quad + \int_{\Omega_n^r \cup \Omega_n^0} (\Div \bQ_n) (v-u_n). \notag
\end{align}

By \eqref{eq:Qiszero} we have $\Div \bQ_n=0$ on $\Omega_n^0$.  However, by \eqref{eq:strongconditionswherezero}, $F_n \le 0$ on $\Omega_n^0$.  Thus
    $$\int_{\Omega_n^0} (\Div \bQ_n) (v-u_n) = 0 \ge \int_{\Omega_n^0} \left(F_n - \frac{u_n - u_{n-1}}{\Delta t}\right) (v-u_n),$$
because $u_n=u_{n-1}=0$ and $v-u_n = v \ge 0$ on $\Omega_n^0$.  Almost the same, by \eqref{eq:Qiszero} and \eqref{eq:strongconditionswherezero} on $\Omega_n^r$,
    $$\int_{\Omega_n^r} (\Div \bQ_n) (v-u_n) = 0 \ge \int_{\Omega_n^r} \left(F_n - \frac{u_n - u_{n-1}}{\Delta t}\right) (v-u_n)$$
because $u_n=0$, $F_n + u_{n-1}/\Delta t \le 0$, and $v-u_n = v \ge 0$ on $\Omega_n^r$.  

Thus if we return to \eqref{eq:equalitybeforeVI} we now have
\begin{align}
-\int_{\Omega} \bQ_n \cdot \grad(v-u_n) &\ge \int_{\Omega_n} \left(F_n - \frac{u_n - u_{n-1}}{\Delta t}\right) (v-u_n) - \int_{\partial \Omega} G_n (v-u_n) \label{eq:essentiallyVI} \\
  &\qquad\quad + \int_{\Omega_n^r \cup \Omega_n^0} \left(F_n - \frac{u_n - u_{n-1}}{\Delta t}\right) (v-u_n). \notag
\end{align}
But \eqref{eq:essentiallyVI} can be written without decomposition \eqref{eq:omegadecomposition}, namely as \eqref{eq:morallytheVI}.
\end{proof}

\medskip
We can now precisely define our weak problem.

\medskip
\begin{definition}  Fix $p>1$.  Let
    $$\mathcal{K} = \left\{v \in W^{1,p}(\Omega) \,\big|\, v(x) \ge 0 \text{ for all } x \in \Omega\right\}.$$
\end{definition}

\begin{definition}  We say $u_n \in \mathcal{K}$ solves the \emph{single-time-step weak problem} if it solves \eqref{eq:morallytheVI}, which we prefer to write as
\begin{align}
&\int_{\Omega} u_n (v-u_n) - \Delta t\, \bQ_n \cdot \grad(v-u_n)  \label{eq:theVI} \\
  &\qquad\qquad \ge \int_{\Omega} \left(u_{n-1} + \Delta t F_n\right) (v-u_n) - \Delta t \int_{\partial \Omega} G_n (v-u_n),  \notag
\end{align}
for all $v \in \mathcal{K}$.
\end{definition}

To complete our program FIXME: converse of above theorem

FIXME: THEOREM: the weak form implies the strong form where $u_n>0$ (``interior condition'')

FIXME:  We will show that in some cases this is well-posed

FIXME:  We will show [ONLY IF $\bQ_n$ HAS $\grad u_n$] that along the free boundary $\Gamma_n^0$ we have both $u_n=0$ and $\bQ_n = 0$.

From now on we use set decomposition \eqref{eq:omegadecomposition} when referring to a solution $u_n$ of the weak form \eqref{eq:theVI}.


\section{Time-series for mass, and the retreat loss}  \label{sec:timeseries}

Now define
\begin{equation}
M_n = \int_\Omega u_n(x)\,dx = \int_{\Omega_n} u_n(x)\,dx, \label{eq:totalmassdefn}
\end{equation}
which we naturally call the \emph{(total) mass} at time $t_n$, and define
\begin{equation}
R_n = \int_{\Omega_n^r} u_{n-1}\,dx, \label{eq:retreatlossdefn}
\end{equation}
which we call the \emph{retreat loss} at time $t_n$.  The total mass and the retreat loss at time $t_n$ are related.  In fact, by \eqref{eq:semimassconserve}, \eqref{eq:totalmassdefn}, and \eqref{eq:retreatlossdefn} we have
\begin{align}
M_n - M_{n-1} &=  - \int_{\Omega_n^r} u_{n-1}\,dx + \int_{\Omega_n} (u_n - u_{n-1})\,dx \label{eq:massstep} \\
   &= - R_n + \Delta t \int_{\Omega_n} (- \Div \bQ_n + F_n) \,dx \notag \\
   &= - R_n + \Delta t \int_{\Gamma_n^N} G_n + \Delta t \int_{\Omega_n} F_n\,dx \notag
\end{align}
because $\bQ_n=0$ along $\Gamma_n^0$ by assumption (ii).

Given the continuous-time solution $u(x,t)$ to problem \eqref{eq:massconserve}--\eqref{eq:constraint} starting with initial condition $u(x,t_{n-1}) = u_{n-1}(x)$, at points $x$ within $\Omega_n^r$ we could define the time at which $u(x,t)$ first becomes zero.  This \emph{time-of-loss function} is well-defined on the retreat set $\Omega_n^r$:
\begin{equation}
\bar t(x) = \inf\left\{t \,\big|\, u(x,t)>0 \,\text{ and }\, t_{n-1} < t \le t_n\right\}.
\end{equation}
While $\bar t(x)$ varies over $\Omega_n^r$, as $\Delta t \to 0$ then $\bar t(x) \to t_{n-1}$.  We might even expect that the area of $\Omega_n^r$ might decrease to zero as $\Delta t \to 0$, though this has not been proven.  But for numerical models, which necessarily have discrete time, the variation in $\bar t(x)$, over $\Omega_n^r$ during the time-step $t_{n-1} < t \le t_n$, is unknown.  Not accounting for the unknown variation of $\bar t(x)$ over the retreat set $\Omega_n^r$ is a barrier to the conservation of discrete (or merely time-discretized) modeled mass.

As an operational statement about discrete-time models, we can rephrase our major assertion from section \ref{sec:intro} as
\begin{quote}
\emph{The model must store a time series for $R_n$, in addition to the expected time series $\int_{\Gamma_n^N} G_n$ and $\int_{\Omega_n} F_n$, in order to provide auditable mass conservation.}
\end{quote}
In stating this assertion, we note that the retreat loss $R_n$ should vanish in the $\Delta t\to 0$ limit, which is a consistency statement about the time-discretized model.


\section{Examples and non-examples} \label{sec:examples}

In this section FIXME

\begin{example}  Let $v_0>0$ and $f_0>0$ be scales for the velocity and source term.  Consider an advecting-layer problem in one dimension, with constant velocity.  That is, if $q = v_0 u$ then the strong form problem for $u(t,x)$ is
\begin{equation}
u_t + v_0 u_x = f(x) \quad \text{ subject to } \quad u\ge 0.  \label{eq:ex:advectlayer}
\end{equation}
Specifically, suppose $x\in[0,L]$ and periodic boundary conditions $u(t,0)=u(t,L)$ and $u_x(t,0)=u_x(t,L)$.  For the source term, consider this particular source that is negative on average:
    $$f(x) = f_0 \left(\sin\left(\frac{2\pi x}{L}\right) - \frac{1}{5}\right).$$

If $\tilde u(t,x)$ solves the same problem without the constraint, and if $\tilde M(t) = \int_0^L \tilde u(t,x)\,dx$ is the continuous-time mass for the unconstrained problem then
    $$\dot{\tilde M}(t) = \int_0^L f(x)\,dx = -\frac{f_0 L}{5} < 0$$
so $\tilde M(t)$ goes to $-\infty$ as a linear function in $t$.

But the constrained solution $u(t,x)$ and the total mass $M(t) = \int_0^L u(t,x)\,dx$ approach finite limits which are independent of the initial state $u(0,x)$.  FIXME: prove this?
\end{example}

\section{Conclusion} \label{sec:conclusion}  FIXME


%         References
\bibliography{lc}
\bibliographystyle{siam}


\appendix

\section{Second-order Runge-Kutta time-discretization}   In Section \ref{sec:discreteform} we describe the time semi-discretization of the continuum strong form \eqref{eq:massconserve}--\eqref{eq:constraint} using the $\theta$ method, thus including the Euler, backward Euler, and trapezoidal rules.  These one-stage time-discretizations generate particular forms for functions $\bQ_n(\bX,v,z),F_n(v,z),G_n(v,z)$ in equations \eqref{eq:semimassconserve}--\eqref{eq:semiconstraint}, and these functions define the single-time-step variational inequality problem \eqref{eq:theVI}.  In this Appendix we illustrate how these functions can be generated for certain Runge-Kutta (RK) schemes, although in some cases at the cost of having to solve multiple problems of type \eqref{eq:theVI} at each time step.  Higher-order RK schemes can be handled without any additional ideas, but we limit our presentation to two-stage schemes for simplicity.

For the $m$-dimensional ODE system
\begin{equation}
  \by' = \bbf(t,\by),  \label{eq:abstractODE}
\end{equation}
every two-stage RK scheme with time-step $h=\Delta t$ can be written with Butcher tableau \cite{AscherPetzold}
\begin{equation}
\begin{array}{c|cc}
\tau_1 & a_{11} & a_{12}  \\
\tau_2 & a_{21} & a_{22}  \\ \hline
       & b_1    & b_2     \\
\end{array}  \label{eq:tableau}
\end{equation}
representing the formulas
\begin{align*}
  \by_{n,i} &= \by_{n-1} + h \sum_{j=1}^2 a_{ij} \bbf(t_{n-1} + \tau_j h, \by_{n,j}), \\
      \by_n &= \by_{n-1} + h \sum_{i=1}^2 b_i \bbf(t_{n-1} + \tau_i h, \by_{n,i}),
\end{align*}
with $i=1,2$ in the first equation.  \emph{Explicit} methods have $a_{ij}=0$ for $j\ge i$ (i.e.~zeros on and above the diagonal) and, by definition, \emph{semi-implicit} methods have $a_{12}=0$.  We consider only explicit and semi-implicit methods in this paper.  For example, the $\theta$-methods used in Section \ref{sec:discreteform} have tableau
\begin{equation*}
\begin{array}{c|cc}
0 &          &   \\
1 & 1-\theta & \theta  \\ \hline
  & 1-\theta & \theta  \\
\end{array}
\end{equation*}
when written as a two-stage scheme.  Note that $\theta>0$ methods are semi-implicit but not diagonally-implicit.

So-called (singly) \emph{diagonally-implicit} RK (``DIRK'') methods are semi-implicit methods for which the diagonal entries $a_{ii}$ are independent of $i$, i.e.~$a_{11}=a_{22}$.  The accuracy of $s$-stage DIRK methods is limited to $p=s+1$ \cite{AscherPetzold}.  There exist strongly S-stable and stiffly-accurate \cite{AscherPetzold} DIRKs with $s$ stages and order of accuracy $p=s$ for $s=1,2,3$ \cite{Alexander1977}.  Note that ``strongly S-stable'' is also called ``stiff decay'' \cite{AscherPetzold}.

The strong stability properties of these DIRK methods are exactly what is needed for many of the applications addressed in the current paper, namely diffusive cases where $\bq \sim - \grad u$.  In these diffusive cases the $m$-dimensional method-of-lines ODE system generated by spatially-semi-discretizing \eqref{eq:massconserve} would become arbitrarily stiff under spatial refinement.  Furthermore, semi-implicit methods have the computational advantage, especially in our large $m$ case arising from discretization of a PDE, that each stage represents a separate linear system of only $m$ equations to solve.  (General $s$-stage implicit RK schemes require solving size $sm$ linear systems, but for semi-implicit RK schemes the matrix has block lower-triangular form.)  DIRK methods have the further advantage that the $m\times m$ matrix $A$ for each stage $i$, or the Jacobian matrix arising from the linearization of the stage, can be re-used at each stage during a step. In fact the matrix has $i$-independent form $A = I - h a_{ii} J$, at least if the Jacobian $J$ is evaluated at only at the start of the time step in the nonlinear case: $J = \frac{\partial \bbf}{\partial y}(t_{n-1},\by_{n-1})$.

Functions $\bQ_n$ and $F_n$ in \eqref{eq:functionalforms} are needed to state the weak problem \eqref{eq:theVI}.  We compute these functions for two particular DIRK schemes, the $(s,p)=(1,2)$ A-stable scheme known as the implicit midpoint rule, and the unique strongly S-stable $(s,p)=(2,2)$ scheme for which $0\le \tau_i\le 1$.  The significance of the latter condition on $\tau_i$ for our context is that the source term $f$ in \eqref{eq:massconserve} is only evaluated at $t$ in the interval $[t_{n-1},t_n]$ when computing $u_n$; the other strongly S-stable $(s,p)=(2,2)$ method, oddly enough, has $\tau_1>1$.

\begin{itemize}
\item We write the implicit midpoint rule as a two-stage scheme with tableau
\begin{equation*}
\begin{array}{c|cc}
0           &    &             \\
\frac{1}{2} & 0  & \frac{1}{2} \\ \hline
            & 0  & 1           \\
\end{array}
\end{equation*}
This scheme has two equations: the first stage is a backward Euler step of $\frac{1}{2} h$, but the second stage is explicit.  Using the notation $\tilde\by = \by_{n,2}$ for the scheme applied to ODE system \eqref{eq:abstractODE}, the equations are
\begin{align}
\tilde\by &= \by_{n-1} + \tfrac{1}{2} h \bbf(t_{n-1}+\tfrac{1}{2}h,\tilde\by), \label{eq:impmida} \\
\by_n &= \by_{n-1} + h \bbf(t_{n-1}+\tfrac{1}{2}h,\tilde\by). \label{eq:impmidb}
\end{align}

Let $t_{n-1/2} = t_{n-1} + \tfrac{1}{2} \Delta t$ using the notation of the main paper.  Then the functions \eqref{eq:functionalforms} for the first stage \eqref{eq:impmida} are
  $$\tilde\bQ(\bX,v,x) = \tfrac{1}{2} \bq(\bX,v,x,t_{n-1/2}) \quad \text{and} \quad \tilde F(v,x) = \tfrac{1}{2} f(v,x,t_{n-1/2}).$$
The functions for the second stage \eqref{eq:impmidb} are
  $$\bQ_n(\bX,v,x) = 0$$
and
  $$\quad F_n(v,x) = f(\tilde u,x,t_{n-1/2}) - \Div \bq(\grad\tilde u,\tilde u,x,t_{n-1/2})$$
where $\tilde u$ denotes the weak solution to the first stage.  Neither of these second-stage functions actually depend on the unknown $v$ because stage \eqref{eq:impmidb} is explicit once \eqref{eq:impmida} is computed.
\item The strongly S-stable $(2,2)$ scheme has tableau
\begin{equation*}
\begin{array}{c|cc}
\alpha & \alpha   &        \\
1      & 1-\alpha & \alpha \\ \hline
       & 1-\alpha & \alpha \\
\end{array}
\end{equation*}
where $\alpha = (2-\sqrt{2})/2 \approx 0.293$.  Noting the stiffly-accurate condition, namely $a_{2j}=b_j$ for $j=1,2$, this scheme also has only two equations, both implicit.  Now using notation $\tilde\by = \by_{n,1}$, the stages are
\begin{align}
\tilde\by &= \by_{n-1} + \alpha h \bbf(t_{n-1}+\alpha h,\tilde\by), \label{eq:sstabledirka} \\
\by_n &= \by_{n-1} + (1-\alpha) h \bbf(t_{n-1}+\alpha h,\tilde\by) + \alpha h \bbf(t_n,\by_n). \label{eq:sstabledirkb}
\end{align}

Let $t_{n;\alpha} = t_{n-1} + \alpha \Delta t$.  The functions \eqref{eq:functionalforms} for the first stage \eqref{eq:sstabledirka} are
  $$\tilde\bQ(\bX,v,x) = \alpha \bq(\bX,v,x,t_{n;\alpha}) \quad \text{and} \quad \tilde F(v,x) = \alpha f(v,x,t_{n;\alpha}).$$
The functions for the second stage \eqref{eq:sstabledirkb} are
   $$\bQ_n(\bX,v,x) = \alpha \bq(\bX,v,x,t_n)$$
and
   $$F_n(v,x) = (1-\alpha) f(\tilde u,x,t_{n;\alpha}) + \alpha f(v,x,t_n) - (1-\alpha) \Div \bq(\grad\tilde u,\tilde u,x,t_{n;\alpha})$$
where $\tilde u$ denotes the weak solution to the first stage.
\end{itemize}

\medskip
The boundary flux functions $G_n$ can be generated similarly.

\end{document}
