\documentclass{beamer}

%\usetheme{default}
\usetheme{Boadilla}
%\usetheme{Pittsburgh}

\usecolortheme{beaver}

\setbeamercovered{transparent}
\setbeamertemplate{navigation symbols}{} %remove navigation symbols

\usepackage[english]{babel}
\usepackage[latin1]{inputenc}

\usepackage{times}
\usepackage[T1]{fontenc}

%\usepackage{animate}

% see http://tex.stackexchange.com/questions/86188/labelling-with-arrows-in-an-automated-way
\usepackage{tikz,amsmath,verbatim}

\newif\ifclipme\clipmetrue
\tikzset{labelstyle/.style={LabelStyle/.append style={#1}},linestyle/.style={LineStyle/.append style={#1}}}
\tikzset{LabelStyle/.initial={},LineStyle/.initial={}}

\newcommand{\mathWithDescription}[4][]{{%
    \tikzset{#1}%
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m#4) {$\displaystyle#2$};
        \ifclipme\begin{pgfinterruptboundingbox}\fi
            \node[above of=m#4,font=\strut, LabelStyle] (l#4) {#3};
            \draw[-,red, LineStyle] (l#4) to (m#4);
        \ifclipme\end{pgfinterruptboundingbox}\fi
    }%
}}

\newcommand{\mathWithDescriptionStarred}[3][]{{%
    \clipmefalse%
    \mathWithDescription[#1]{#2}{#3}{\themathLabelNode}%
}}

\newcounter{mathLabelNode}

\newcommand{\mathLabelBox}[3][]{%
   \stepcounter{mathLabelNode}%
   \mathWithDescription[#1]{#2}{#3}{\themathLabelNode}%
   \vphantom{\mathWithDescriptionStarred[#1]{#2}{#3}{\themathLabelNode}}%
}

% math macros
\newcommand\bb{\mathbf{b}}
\newcommand\bbf{\mathbf{f}}
\newcommand\bn{\mathbf{n}}
\newcommand\bq{\mathbf{q}}
\newcommand\bs{\mathbf{s}}
\newcommand\bu{\mathbf{u}}
\newcommand\bv{\mathbf{v}}
\newcommand\bx{\mathbf{x}}
\newcommand\by{\mathbf{y}}
\newcommand\bz{\mathbf{z}}

\newcommand\bF{\mathbf{F}}
\newcommand\bQ{\mathbf{Q}}
\newcommand\bU{\mathbf{U}}
\newcommand\bV{\mathbf{V}}
\newcommand\bX{\mathbf{X}}

\newcommand\CC{\mathbb{C}}
\newcommand\RR{\mathbb{R}}

\newcommand{\DDt}[1]{\ensuremath{\frac{d #1}{d t}}}
\newcommand{\ddt}[1]{\ensuremath{\frac{\partial #1}{\partial t}}}

\newcommand\Div{\nabla\cdot}
\newcommand\eps{\epsilon}
\newcommand\grad{\nabla}
\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}
\newcommand\nhat{\mathbf{n}}
\newcommand\lam{\lambda}
\newcommand\lap{\triangle}
\newcommand\Matlab{\textsc{Matlab}\xspace}
\newcommand\vf{\varphi}


\title[Computing glacier geometry]{Computing glacier geometry \\ in nonlinear complementarity problem form}

\author{Ed Bueler}

\institute[UAF] % (optional, but mostly needed)
{
  Dept of Mathematics and Statistics, and Geophysical Institute\\
  University of Alaska Fairbanks \\
  \tiny (\emph{funded by NASA Modeling, Analysis, and Prediction program})%
}

\date[Copper Mtn 2016]{Copper Mountain Iterative March 2016}


\begin{document}
\graphicspath{{../../talks-public/commonfigs/}}

\begin{frame}
  \titlepage
\end{frame}


\begin{frame}{outline}
  \tableofcontents
\end{frame}


\section{NCPs and VIs: 4 slide intro}

\begin{frame}{nonlinear complementarity problems (NCP)}

\begin{itemize}
\item in finite dimensions, an NCP is to find $\bz\in\RR^n$ for which
\begin{equation}
\bz \ge 0, \quad \bF(\bz) \ge 0, \quad \bz^\top \bF(\bz) = 0, \label{ncp}
\end{equation}
given a differentiable map $\bF:\RR^n \to \RR^n$
\end{itemize}

\begin{columns}
\begin{column}{0.5\textwidth}
\small
\begin{itemize}
\item \alert{example}: obstacle problem is to find $u(x)$ so that $u''(x) \le 0$, $u(x) \ge \psi(x)$, and either $u=\psi$ or $-u''(x) = 0$
\item discretized and put in form \eqref{ncp}: $z_j=u_j - \psi(x_j)$ and
  $$F_j(\bz) = - \frac{z_{j+1} - 2 z_j + z_{j-1}}{\Delta x^2} - \psi''(x_j)$$
\end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\includegraphics[width=\textwidth,keepaspectratio=true]{obstacle1d}
\end{column}
\end{columns}
\end{frame}


\begin{frame}{variational inequalities (VI)}

\begin{itemize}
\item in finite dimensions, a VI is to find $\bz\in\mathcal{K}$, where $\mathcal{K}\subseteq \RR^n$ is convex and closed, for which
\begin{equation}
     \ip{\bF(\bz)}{\by-\bz} \ge 0 \quad \forall \by \in \mathcal{K},
\end{equation}
given a differentiable map $\bF:\RR^n \to \RR^n$
\end{itemize}

\begin{columns}
\begin{column}{0.5\textwidth}
\small
\begin{itemize}
\item obstacle problem has $\mathcal{K} = \{z_j \ge \psi(x_j)\}$ and
  $$F_j(\bz) = - \frac{z_{j+1} - 2 z_j + z_{j-1}}{\Delta x^2}$$
\end{itemize}
\end{column}
\begin{column}{0.5\textwidth}
\includegraphics[width=\textwidth,keepaspectratio=true]{obstacle1d}
\end{column}
\end{columns}\end{frame}


\begin{frame}{generalities}

\begin{itemize}
\item both VI and NCP generalize nonlinear equations ``$\bF(\bz)=0$'' to allow constraints on $\bz$
  \begin{itemize}
  \item[$\circ$]  in finite dimensions: NCP $\iff$ VI
  \item[$\circ$]  for obstacle problems, if $\psi\equiv 0$ then $\bF$ is same in NCP and VI
  \end{itemize}
\item even if $\bF(\bx)$ is linear, the NCP or VI problem is nonlinear
  \begin{itemize}
  \item[$\circ$]  solution space is not affine
  \item[$\circ$]  of course: iteration obligatory for $n$ large
  \end{itemize}
\item constrained optimization $\implies$ NCP $\iff$ VI
  \begin{itemize}
  \item[$\circ$]  i.e.~find minimum of $\Phi[\bz]$ from $\mathcal{K}$
  \item[$\circ$]  constrained optimization generates symmetric Jacobian/Hessian ($J = \bF' = \Phi''$)
  \item[$\circ$]  \alert{but} NCP and VI problems arising in glacier problems are not (generally) optimizations, and don't have symmetric Jacobians
  \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}{numerics (gloss)}

\begin{itemize}
\item support for NCP and/or VI \dots \emph{as known to me}:
  \begin{itemize}
  \item[$\circ$]  PETSc SNES \dots \emph{I used this}
  \item[$\circ$]  TAO (in PETSc release; separate implementations from SNES)
  \item[$\circ$]  DUNE (maintained?)
  \end{itemize}
\item 2 Newton line search methods in PETSc SNES:
  \begin{itemize}
  \item[$\circ$]  due to Benson \& Munson (2006), and Barry Smith
  \item[$\circ$]  neither assume optimization
  \item[$\circ$]  ``reduced-space'' = \alert{RS}
    \begin{itemize}
    \item active set $= \mathcal{A} = \{i \,:\, z_i = 0 \text{ and } F_i(\bz) > 0\}$
    \item inactive set $= \mathcal{I} = \{i \,:\, z_i > 0 \text{ or } F_i(\bz) \le 0\}$
    \item \emph{alg}: compute Newton step $\bs^k$ by $\big[J(\bz^k)\big]_{\mathcal{I}^k,\mathcal{I}^k} \bs_{\mathcal{I}^k} = - \bF_{\mathcal{I}^k}(\bz^k)$; do projected line search onto $\{\bz\ge 0\}$
    \end{itemize}
  \item[$\circ$]  ``semi-smooth'' = \alert{SS}
    \begin{itemize}
    \item ``NCP function'' satisfies $\phi(a,b)=0$ if and only if $a\ge 0,b\ge 0,ab=0$
    \item \emph{alg}: compute Newton step $\bs^k$ by $L^k \bs^k = - \phi(\bz^k,\bF^k(\bz^k))$ where $L^k$ is any element of $\partial_B \phi(\bz^k,\bF^k(\bz^k))$; do line search
    \end{itemize}
  \end{itemize}
\end{itemize}
\end{frame}


%  $\infty$ dimensions
% comes from with mass conservation (MC) equation $H_t + \Div\bq = f$
%  $\bx = H$ and $\bF(\bx) = (\text{residual from discrete-time  MC eqn.})$
%  the mass continuity equation is not (generally) an Euler-Lagrange (variational) equation of a functional
%  Jouvet \& Bueler (2012) solve problem as fixed-point sequence of optimizations, but this loses Newton quadratic convergence character
% Jacobians are \emph{not} generally symmetric

\AtBeginSection[] % Do nothing for \section*
{
\begin{frame}<beamer>
\frametitle{outline}
\tableofcontents[currentsection]
\end{frame}
}

\section{glacier geometry-evolution models}

\begin{frame}{glacier notation}

\begin{center}
\includegraphics[width=0.5\textwidth,keepaspectratio=true]{groundedscheme}
\end{center}

\begin{itemize}
\item unknowns:
  \begin{itemize}
  \item[$\circ$]  $h(t,x,y)$ ice thickness \hfill \dots also $s=h+b$ surface elevation
  \item[$\circ$]  $\bU(t,x,y,z)$ ice velocity
  \end{itemize}
\item ``data'':
  \begin{itemize}
  \item[$\circ$]  $b(x,y)$ bed elevation
  \item[$\circ$]  $a(t,x,y)$ surface mass balance (accumulation/ablation function)
  \end{itemize}
\item ignored here:
  \begin{itemize}
  \item[$\circ$]  temperature/enthalpy, and conservation of energy
  \item[$\circ$]  floating ice
  \item[$\circ$]  bed deformation
  \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}{coupled mass and momentum equations}

\begin{itemize}
\item FIXME
\end{itemize}
\end{frame}


\begin{frame}{a free-boundary fluid layer in a climate}

\begin{center}
\includegraphics[width=0.95\textwidth,keepaspectratio=true]{cartoon-wclimate}
\end{center}

\vspace{-7mm}
  \begin{itemize}
  \item mass conservation PDE for a layer:
      $$h_t + \Div\bq = {\color{blue} f}$$
    \begin{itemize}
    \vspace{-4mm}
    \item[$\circ$] $h$ is a thickness: $h\ge 0$
    \item[$\circ$] mass conservation PDE applies only where $h>0$
    \item[$\circ$] $\bq$ is flow (vertically-integrated)
    \item[$\circ$] source ${\color{blue} f}$ is ``climate''; ${\color{blue} f}>0$ shown downward
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}{examples with similar character}

\includegraphics[width=0.4\textwidth,keepaspectratio=true]{polaris}
\hfill
\includegraphics[width=0.45\textwidth,keepaspectratio=true]{supp4rignot-small}

\small glaciers \hfill ice shelves \& sea ice

\medskip
\includegraphics[width=0.41\textwidth,keepaspectratio=true]{marsh-water}
\hfill
\includegraphics[width=0.42\textwidth,keepaspectratio=true]{tsunami-sendai}

\small tidewater marsh \hfill tsunami inundation

\medskip
\scriptsize and also surface hydrology, subglacial hydrology, \dots
\end{frame}


\section{every time-step is free-boundary problem}

\begin{frame}{semi-discretize in time}

$$h_t + \Div\bq = f \qquad \to \qquad \frac{H_n - H_{n-1}}{\Delta t} + \Div \bQ_n = F_n$$

  \begin{itemize}
  \item semi-discretize in time: $H_n(x) \approx h(t_n,x)$
  \item the new equation is strong form \alert{single time-step problem}
    \begin{itemize}
    \item[$\circ$] a PDE in space where $H_n>0$
    \item[$\circ$] details of flux $\bQ_n$ and source $F_n$ come from time-stepping scheme
      \begin{itemize}
      \item e.g.~$\theta$-methods or RK
      \end{itemize}
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}{weak form incorporates $H_n\ge 0$ constraint}

  \begin{itemize}
  \item define:
    $$\mathcal{K} = \left\{v \in W^{1,p}(\Omega) \,\Big|\, v\ge 0\right\} = \text{\alert{admissible thicknesses}}$$
  \item we say $H_n \in \mathcal{K}$ solves the \alert{weak single time-step problem} if
    $$\int_\Omega H_n (v - H_n) - \Delta t\, \bQ_n \cdot \grad(v - H_n) \ge \int_\Omega \left(H_{n-1} + \Delta t\, F_n\right) (v - H_n)$$
  for all $v \in \mathcal{K}$
  \small
  \medskip
    \begin{itemize}
    \item[$\circ$] derive this \emph{variational inequality} (VI) from:
      \begin{itemize}
      \item[$\diamond$] integration-by-parts on strong form
      \item[$\diamond$] thought about $H_n=0$ areas
      \end{itemize}
    \end{itemize}
  \end{itemize}
\end{frame}


\begin{frame}{weak solves strong but gives more info}

\begin{itemize}
  \item assume $\bQ_n=0$ when $H_n=0$
    \begin{itemize}
    \item[$\circ$] this means $\bQ_n$ describes a \emph{layer}
    \end{itemize}
  \item if $H_n \in \mathcal{K}$ solves weak single time-step problem (VI) then
  
      \medskip
	  \begin{itemize}
	  \item[$\circ$] PDE applies on the set where $H_n>0$ (interior condition):
	    $$\frac{H_n - H_{n-1}}{\Delta t} + \Div \bQ_n = F_n$$
	  \item[$\circ$] plus inequality on the set where $H_n = 0$:
	    $$H_{n-1} + \Delta t\, F_n \le 0$$
	    \vspace{-6mm}
	    \begin{itemize}
	    \item ``climate negative enough during time step to remove old thickness''
	    \end{itemize}
	  \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}{the 3 nonlinearities of the glacier geometry problem}

not counting possible sliding and elevation-accumulation feedbacks
\begin{itemize}
\item the constrained problem (VI or NCP) is inherently nonlinear, i.e.~iteration is needed even for LCPs
\item the $p=n+1$ glen power generates a nonlinearity even in steady state on a flat bed (in that case the ``doubly-nonlinear'' MC equation can be transformed to a straight $p$-laplacian equation)
\item nonzero bedrock gradient ``brings back'' a nonlinearity (Jouvet \& Bueler 2012)
\end{itemize}
\end{frame}


\section{discretization scheme: FVE}

\begin{frame}{finite volume element schemes}

\begin{itemize}
\item FIXME
\end{itemize}

\end{frame}


\begin{frame}{careful: quadrature and upwinding}

\begin{itemize}
\item FIXME
\end{itemize}

\end{frame}


\section{numerical solution: constrained Newton}

\begin{frame}{numerical solution of the weak problem}

the weak single time-step problem:
\begin{itemize}
\item is nonlinear because of constraint (even for $\bQ_n$ linear in $H_n$)
\item can be solved by a Newton method modified for constraint
\item scalable implementations are in PETSc
  \begin{itemize}
  \item[$\circ$]  see ``SNESVI'' object
  \item[$\circ$]  for NCP there are two implementations (Benson \& Munson, 2006):
    \begin{itemize}
    \item  reduced-set (active-set) method
    \item  semismooth method
    \end{itemize}
  \end{itemize}
\end{itemize}

\end{frame}


\section{the essential difficulty} % i.e. bedrock roughness

\begin{frame}{example: Greenland ice sheet}

\begin{columns}
\begin{column}{0.6\textwidth}
\begin{itemize}
\small
\item given steady climate and bedrock elevations, what is shape of Greenland ice sheet?
  \begin{itemize}
  \scriptsize
  \item[$\circ$] climate = ``surface mass balance''
  \item[] \qquad = precipitation $-$ runoff-from-melt
  \end{itemize}
\small
\item assume simplest reasonable dynamics: non-sliding shallow ice approximation
\item solve VI/NCP weak problem
  \begin{itemize}
  \scriptsize
  \item[$\circ$] steady state ($\Delta t\to \infty$)
  \item[$\circ$] reduced-set Newton method
  \item[$\circ$] 900 m structured grid
  \item[$\circ$] $Q^1$ FEs in space
  \item[$\circ$] $N=7\times 10^6$ d.o.f.
  \end{itemize}
\end{itemize}

\vspace{5mm}
\tiny (Bueler, submitted to J.~Glaciol.)
\end{column}
\begin{column}{0.4\textwidth}
\vspace{-5mm}

\begin{center}
\includegraphics[width=0.95\textwidth,keepaspectratio=true]{grnwinset}
\end{center}
\end{column}
\end{columns}
\end{frame}


\begin{frame}{summary}

FIXME consider layer flow model \, $h_t + \Div\bq = f$ \, subject to signed climate $f$ and where $h$ is layer thickness

  \begin{itemize}
  \item goals/issues:
    \begin{itemize}
    \item[$\circ$]  long time steps wanted
    \item[$\circ$]  models have been limited by free-boundary lack-of-clarity
    \end{itemize}
  \item approach:
    \begin{itemize}
    \item[$\circ$]  include constraint on thickness: $h\ge 0$
    \item[$\circ$]  consider discrete-time problem before doing FEM/FVM/etc.
    \item[$\circ$]  pose single time-step problem weakly as VI or NCP
    \item[$\circ$]  solve by scalable constrained-Newton method (PETSc)
    \end{itemize}
  \end{itemize}

\end{frame}

\end{document}
